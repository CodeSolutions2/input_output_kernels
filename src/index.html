<!DOCTYPE>
<html>
<head></head>
<body>

<button onclick="regression_model()">0. Regression model</button>

<button onclick="compile_model()">1. Compile model</button>

<button onclick="train_model()">2. Train model</button>

<button onclick="predict()">3. Predict</button>

<button onclick="plot_data()">4. Plot</button>

<div id="display_data">

<div id="output">

<style>
button { background-color: green; }
button:active { background-color: red; }
</style>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>

<script src="https://cdn.plot.ly/plotly-2.30.0.min.js" charset="utf-8"></script>

<script>

// Obtain training dataset.
var [xs_2d, ys_1d] = obtain_train_data();
document.getElementById("output").innerHTML += "xs_2d: "+xs_2d+"<br>";
document.getElementById("output").innerHTML += "ys_1d: "+ys_1d+"<br>";

// Obtain test dataset.
var xs_test = obtain_test_data();
document.getElementById("output").innerHTML += "xs_test: "+xs_test+"<br>";

var featureNum = xs_2d.at(0).length; // columns of xs
document.getElementById("output").innerHTML += "featureNum: "+featureNum+"<br>";
const outputNum = 1; // columns of ys
var model;
var t;
var feature2_ds2;


function timeSampling_array() {

  const n = 100;
  var f = 1/10; // sampling rate.
  var t = Array.from({length:n}, (v,i) => { return i*f; });
  return t;
}


function topic_measurements() {
  
  t = timeSampling_array();

  var sin0 = t.map((v,i) => { return Math.sin(v); });
  var sin1 = t.map((v,i) => { return 5*Math.sin(v); });
  var sin2 = t.map((v,i) => { return 10*Math.sin(v); });

  return [sin0, sin1, sin2];
}


function obtain_train_data() {

  var [sin0, sin1, sin2] = topic_measurements();

  // Past dataset 0
  var feature0_ds0 = sin0.map((v,i) => { return v+(0.1*Math.random()); });
  var feature1_ds0 = sin1.map((v,i) => { return v+(0.01*Math.random()); });
  var feature2_ds0 = sin2.map((v,i) => { return v+(0.1*Math.random()); });

  // Past dataset 1
  var feature0_ds1 = sin0.map((v,i) => { return v+(0.01*Math.random()); });
  var feature1_ds1 = sin1.map((v,i) => { return v+(0.1*Math.random()); });
  var feature2_ds1 = sin2.map((v,i) => { return v+(0.001*Math.random()); });
  
  // Way 0: stack past data
  var xs = [];
  var ys = [];
  var samples = sin0.length;
  for (var i=0; i<samples; i++) {
    
    // Randomly select features from each past dataset.
    var j = Math.floor(2*Math.random());

    var x_stack = [[feature0_ds0.at(i), feature0_ds1.at(i)], 
                   [feature1_ds0.at(i), feature1_ds1.at(i)]];
  
    xs.push(x_stack.at(j));

    var y_stack = [feature2_ds0.at(i), feature2_ds1.at(i)];
    
    ys.push(y_stack.at(j));
  }
    return [xs, ys];
}


function obtain_test_data() {

  var [sin0, sin1, sin2] = topic_measurements();

  // Current dataset
  var feature0_ds2 = sin0.map((v,i) => { return v+(0.001*Math.random()); });
  var feature1_ds2 = sin1.map((v,i) => { return v+(0.001*Math.random()); });
  var xs_test = feature0_ds2.map((v,i) => { return [v, feature1_ds2.at(i)]; });

  return xs_test;
}


function regression_model() {

  const input = tf.input({shape: [featureNum]}); 
  const denseLayer1 = tf.layers.dense({units: 64, activation: "relu"});
  const denseLayer2 = tf.layers.dense({units: 64, activation: "relu"});
  const denseLayer3 = tf.layers.dense({units: 64, activation: "relu"});
  const denseLayer4 = tf.layers.dense({units: outputNum});  
  const output = denseLayer4.apply(denseLayer3.apply(denseLayer2.apply(denseLayer1.apply(input))));
  model = tf.model({inputs: input, outputs: output});

  document.getElementById("output").innerHTML += "model: "+model+"<br>";
}


function compile_model() {
  model.compile({optimizer: tf.train.adam(), loss: tf.losses.meanSquaredError, metrics: ["mse"],});
}


function train_model() {  

  const batchSize = 1;
  const epochs = 300;
  const history = model.fit(tf.tensor(xs_2d), tf.tensor(ys_1d), { 
	batchSize: batchSize, 
	epochs: epochs,
  });
  document.getElementById("output").innerHTML += "history: "+history+"<br>";
}


function predict() {

  var result = model.predict(tf.tensor(xs_test));

  feature2_ds2 = result.arraySync();

  document.getElementById("output").innerHTML += "feature2_ds2.length: "+feature2_ds2.length+"<br>";
  document.getElementById("output").innerHTML += "ys_1d.length: "+ys_1d.length+"<br>";
  // document.getElementById("output").innerHTML += "output2: "+result+"<br>"; // tensor
}



function plot_data() {

  var y_prediction = feature2_ds2.flat();
  var y_actual = ys_1d.flat();

  var title_text = "plot title"; 
  var x_text_trace1and2 = "x"; 
  var y_text_trace1and2 = "y"; 
  var trace1 = {x: t, y: y_prediction, mode: "lines+markers", type: "line", name: "y_prediction"}; 
  var trace2 = {x: t, y: y_actual, mode: "lines+markers", type: "line", name: "y_actual"}; 
  var data = [trace1, trace2]; 
  var layout = {grid: {rows: 1, columns: 1, pattern: "independent"}, title: title_text, xaxis: {title: x_text_trace1and2}, yaxis: {title: y_text_trace1and2}}; 
  Plotly.newPlot("display_data", data, layout);
}

</script>
</body>
</html>
